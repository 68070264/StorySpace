<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Countdown Timer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 720px;
      /* padding: 0 16px; */
    }
    h1 {
      margin: 0 0 8px;
    }
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }
    input[type="number"] {
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      width: 90px;
      text-align: center;
    }
    button {
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid #ddd;
      cursor: pointer;
      background-color: #f7f7f7;
    }
    button:hover {
      background-color: #eee;
    }
    #display {
      font-size: 3rem;
      font-weight: 800;
      letter-spacing: 2px;
      margin: 16px 0 6px;
      text-align: center;
    }
    .muted {
      color: #666;
      font-size: .95rem;
      text-align: center;
    }
  </style>
</head>
<body>

  <main>
    <h1 style="text-align:center;">Python Countdown</h1>

    <form id="timerForm">
      <label>ชั่วโมง:</label>
      <input type="number" id="hours" min="0" step="1" value="0" />
      <label>นาที:</label>
      <input type="number" id="minutes" min="0" max="59" step="1" value="0" />
      <label>วินาที:</label>
      <input type="number" id="seconds" min="0" max="59" step="1" value="0" />
      <button type="submit">Start</button>
      <button type="button" id="stopBtn">Stop</button>
    </form>

    <div id="display">00:00:00</div>
    <div id="status" class="muted">Ready go!!</div>

    <noscript>ต้องเปิดการใช้งาน JavaScript เพื่อให้ตัวจับเวลาทำงาน</noscript>
  </main>

  <script>
    let es = null;
  
    function stopStream() {
      if (es) {
        es.close();
        es = null;
        document.getElementById("status").textContent = "Stopped";
      }
    }
  
    document.getElementById("stopBtn").addEventListener("click", stopStream);
  
    document.getElementById("timerForm").addEventListener("submit", (e) => {
      e.preventDefault();
      stopStream();
  
      const hours = parseInt(document.getElementById("hours").value || "0");
      const minutes = parseInt(document.getElementById("minutes").value || "0");
      const seconds = parseInt(document.getElementById("seconds").value || "0");
  
      const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
  
      if (totalSeconds <= 0) {
        alert("กรุณาใส่เวลาอย่างน้อย 1 วินาที");
        return;
      }
  
      document.getElementById("display").textContent = "connecting...";
      document.getElementById("status").textContent = "Connecting...";
  
      es = new EventSource(`/api/timer-stream?seconds=${totalSeconds}`);
  
      es.onmessage = (evt) => {
        document.getElementById("display").textContent = evt.data;
        document.getElementById("status").textContent = "Running...";
      };
  
      es.addEventListener("done", (evt) => {
        document.getElementById("display").textContent = evt.data || "Time's up!";
        document.getElementById("status").textContent = "✅ Finished";
  
        // ✅ แสดง popup แจ้งเตือนเมื่อหมดเวลา
        alert("⏰ Time's up!");
  
        stopStream();
      });
  
      es.onerror = () => {
        document.getElementById("status").textContent = "Connection error";
        stopStream();
      };
    });
  </script>
  
</body>
</html>
